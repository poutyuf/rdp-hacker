name: AvicaRDP-with-Ngrok
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 6 saatte bir otomatik yeniden baÅŸlatma

jobs:
  build:
    name: Ngrok ile RDP Kurulumu
    runs-on: windows-latest
    timeout-minutes: 350
    
    steps:
    - name: Ngrok ve RDP Kurulumu
      run: |
        # Ngrok indirme ve kurulum
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive -Path ngrok.zip -DestinationPath .
        
        # Ngrok kimlik doÄŸrulama (token GitHub Secrets'tan alÄ±nacak)
        ./ngrok/ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
        
        # RDP'yi etkinleÅŸtirme
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # KullanÄ±cÄ± ve ÅŸifre ayarlama
        net user runneradmin TheDisa1a /add
        net localgroup administrators runneradmin /add
        
        # Ngrok ile RDP tÃ¼neli oluÅŸturma (arka planda Ã§alÄ±ÅŸacak)
        Start-Process -FilePath "./ngrok/ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
        
        # BaÄŸlantÄ± bilgilerini gÃ¶ster
        Write-Host "âœ… RDP ve Ngrok kurulumu tamamlandÄ±!" -ForegroundColor Green
        Write-Host "ğŸ“¡ Ngrok baÄŸlantÄ±sÄ± hazÄ±rlanÄ±yor..." -ForegroundColor Yellow
        
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: BaÄŸlantÄ± Bilgilerini GÃ¶ster
      run: |
        # 10 saniye ngrok'un baÅŸlamasÄ±nÄ± bekle
        Start-Sleep -Seconds 10
        
        # Ngrok API'sinden baÄŸlantÄ± bilgilerini al
        $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction SilentlyContinue
        if ($tunnels) {
            $public_url = $tunnels.tunnels[0].public_url
            $rdp_address = $public_url -replace "tcp://", ""
            $rdp_host, $rdp_port = $rdp_address -split ":"
            
            Write-Host "
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘           NGROK RDP BAÄLANTISI           â•‘  
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ğŸŒ BaÄŸlantÄ± Adresi: $rdp_host
            ğŸšª Port NumarasÄ±: $rdp_port
            ğŸ‘¤ KullanÄ±cÄ± AdÄ±: runneradmin
            ğŸ”’ Åifre: TheDisa1a
            
            ğŸ“‹ BaÄŸlantÄ± iÃ§in:
            1. Windows'ta Uzak MasaÃ¼stÃ¼ BaÄŸlantÄ±sÄ±'nÄ± aÃ§Ä±n
            2. Bilgisayar alanÄ±na: $rdp_host:$rdp_port yazÄ±n
            3. KullanÄ±cÄ± adÄ± ve ÅŸifreyle baÄŸlanÄ±n
            
            âš ï¸ Not: Bu baÄŸlantÄ± 6 saat sonra sonlanacaktÄ±r
            " -ForegroundColor Cyan
        } else {
            Write-Host "âŒ Ngrok baÄŸlantÄ±sÄ± alÄ±namadÄ±. LÃ¼tfen manuel olarak kontrol edin." -ForegroundColor Red
        }
        
    - name: Oturum SÃ¼resince Ã‡alÄ±ÅŸmaya Devam Et
      run: |
        Write-Host "â³ RDP baÄŸlantÄ±sÄ± 6 saat boyunca aktif kalacak..." -ForegroundColor Yellow
        # 350 dakika (timeout sÃ¼resi) boyunca bekle
        Start-Sleep -Seconds 21000
