name: AvicaRDP-with-Ngrok
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 6 saatte bir otomatik yeniden başlatma

jobs:
  build:
    name: Ngrok ile RDP Kurulumu
    runs-on: windows-latest
    timeout-minutes: 350
    
    steps:
    - name: Ngrok ve RDP Kurulumu
      run: |
        # Ngrok indirme ve kurulum
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive -Path ngrok.zip -DestinationPath .
        
        # Ngrok kimlik doğrulama (token GitHub Secrets'tan alınacak)
        ./ngrok/ngrok.exe authtoken $env:NGROK_AUTH_TOKEN
        
        # RDP'yi etkinleştirme
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Kullanıcı ve şifre ayarlama
        net user runneradmin TheDisa1a /add
        net localgroup administrators runneradmin /add
        
        # Ngrok ile RDP tüneli oluşturma (arka planda çalışacak)
        Start-Process -FilePath "./ngrok/ngrok.exe" -ArgumentList "tcp 3389" -WindowStyle Hidden
        
        # Bağlantı bilgilerini göster
        Write-Host "✅ RDP ve Ngrok kurulumu tamamlandı!" -ForegroundColor Green
        Write-Host "📡 Ngrok bağlantısı hazırlanıyor..." -ForegroundColor Yellow
        
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: Bağlantı Bilgilerini Göster
      run: |
        # 10 saniye ngrok'un başlamasını bekle
        Start-Sleep -Seconds 10
        
        # Ngrok API'sinden bağlantı bilgilerini al
        $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction SilentlyContinue
        if ($tunnels) {
            $public_url = $tunnels.tunnels[0].public_url
            $rdp_address = $public_url -replace "tcp://", ""
            $rdp_host, $rdp_port = $rdp_address -split ":"
            
            Write-Host "
            ╔══════════════════════════════════════════╗
            ║           NGROK RDP BAĞLANTISI           ║  
            ╚══════════════════════════════════════════╝
            
            🌐 Bağlantı Adresi: $rdp_host
            🚪 Port Numarası: $rdp_port
            👤 Kullanıcı Adı: runneradmin
            🔒 Şifre: TheDisa1a
            
            📋 Bağlantı için:
            1. Windows'ta Uzak Masaüstü Bağlantısı'nı açın
            2. Bilgisayar alanına: $rdp_host:$rdp_port yazın
            3. Kullanıcı adı ve şifreyle bağlanın
            
            ⚠️ Not: Bu bağlantı 6 saat sonra sonlanacaktır
            " -ForegroundColor Cyan
        } else {
            Write-Host "❌ Ngrok bağlantısı alınamadı. Lütfen manuel olarak kontrol edin." -ForegroundColor Red
        }
        
    - name: Oturum Süresince Çalışmaya Devam Et
      run: |
        Write-Host "⏳ RDP bağlantısı 6 saat boyunca aktif kalacak..." -ForegroundColor Yellow
        # 350 dakika (timeout süresi) boyunca bekle
        Start-Sleep -Seconds 21000
